{% extends "base.html" %}
{% block title %}Report #{{ report.id }}{% endblock %}

{% block content %}
<!-- ğŸ¦´ Skeleton Loading Overlay -->
<div id="dashboard-skeleton"
  class="fixed inset-0 z-[60] bg-gray-50 dark:bg-gray-900 overflow-hidden pointer-events-none transition-opacity duration-700 p-8">
  <div class="max-w-7xl mx-auto space-y-8">
    <div class="h-10 w-48 skeleton rounded-xl"></div>
    <div class="h-[600px] w-full skeleton rounded-3xl"></div>
  </div>
</div>

<script>
  window.addEventListener('load', () => {
    const skeleton = document.getElementById('dashboard-skeleton');
    if (skeleton) {
      skeleton.style.opacity = '0';
      setTimeout(() => skeleton.remove(), 700);
    }
  });
</script>

<div class="min-h-[calc(100vh-6rem)] py-12 px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto">

  <!-- Breadcrumb -->
  <a href="{% url 'my_reports' %}"
    class="inline-flex items-center gap-2 text-gray-500 hover:text-eco-600 font-medium mb-8 transition-colors">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
    </svg>
    Back to Reports
  </a>

  <!-- Main Card -->
  <div
    class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl overflow-hidden grid grid-cols-1 lg:grid-cols-2 animate-fade-in relative">

    <!-- Left: Image Section -->
    <div class="relative h-64 md:h-96 lg:h-full lg:min-h-[500px]">
      {% if report.image %}
      <img src="{{ report.image.url }}" class="absolute inset-0 w-full h-full object-cover"
        onerror="this.src='https://plus.unsplash.com/premium_photo-1663045498422-9a95cca250ed?q=80&w=800&auto=format&fit=crop'">
      {% else %}
      <div
        class="absolute inset-0 w-full h-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-gray-400">
        <span class="text-6xl">ğŸ“¸</span>
      </div>
      {% endif %}
      <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent"></div>

      <div class="absolute bottom-4 left-4 md:bottom-8 md:left-8 text-white pr-4">
        <div
          class="inline-block px-3 py-1 md:px-4 md:py-1.5 rounded-full bg-white/20 backdrop-blur-md border border-white/30 text-xs md:text-sm font-bold mb-2 md:mb-3">
          {{ report.get_waste_type_display }}
        </div>
        <h1 class="text-2xl md:text-3xl lg:text-4xl font-heading font-bold mb-1 md:mb-2">Report #{{ report.id }}</h1>
        <p class="text-white/80 flex flex-wrap items-center gap-2 text-xs md:text-sm font-medium">
          <span>ğŸ“… {{ report.created_at|date:"F d, Y" }}</span>
          <span class="hidden md:inline">â€¢</span>
          <span>â° {{ report.created_at|date:"h:i A" }}</span>
        </p>
      </div>
    </div>

    <!-- Right: Details Section -->
    <div class="p-6 md:p-8 lg:p-12 flex flex-col justify-center bg-white dark:bg-gray-800 relative">

      <!-- Status Badge (Floating) -->
      <div class="absolute top-4 right-4 md:top-8 md:right-8">
        <span
          class="px-3 py-1.5 md:px-4 md:py-2 rounded-xl font-bold uppercase tracking-wider text-[10px] md:text-sm shadow-sm border
          {% if report.status == 'pending' %} bg-yellow-50 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400 border-yellow-200 dark:border-yellow-800
          {% elif report.status == 'assigned' %} bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 border-blue-200 dark:border-blue-800
          {% else %} bg-eco-50 dark:bg-eco-900/30 text-eco-700 dark:text-eco-400 border-eco-200 dark:border-eco-800 {% endif %}">
          {{ report.status }}
        </span>
      </div>

      <div class="space-y-8">

        <!-- ğŸ“„ Download PDF Report Card -->
        <div>
          <a href="{% url 'export_report_pdf' report.id %}"
            class="flex items-center gap-2 text-xs font-bold text-gray-400 hover:text-eco-600 transition-colors uppercase tracking-widest">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
              stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            Download Official Report Card (PDF)
          </a>
        </div>

        <!-- Severity Section -->
        <div>
          <h3 class="text-gray-400 dark:text-gray-500 text-sm uppercase tracking-widest font-bold mb-3">Severity Level
          </h3>
          <div class="flex items-center gap-3">
            <div class="h-3 flex-1 rounded-full bg-gray-100 dark:bg-gray-700 overflow-hidden">
              <div class="h-full rounded-full 
                {% if report.severity == 'low' %} bg-green-500 w-1/3
                {% elif report.severity == 'medium' %} bg-yellow-500 w-2/3
                {% else %} bg-red-500 w-full {% endif %}">
              </div>
            </div>
            <span class="text-lg font-bold capitalize 
              {% if report.severity == 'low' %} text-green-600
              {% elif report.severity == 'medium' %} text-yellow-600
              {% else %} text-red-600 {% endif %}">
              {{ report.severity }}
            </span>
          </div>
        </div>

        <!-- Description -->
        <div>
          <h3 class="text-gray-400 dark:text-gray-500 text-sm uppercase tracking-widest font-bold mb-3">Description</h3>
          <p class="text-gray-700 dark:text-gray-300 leading-relaxed text-lg">
            {{ report.description }}
          </p>
        </div>

        <!-- Location (Placeholder if lat/lng exists) -->
        {% if report.latitude and report.longitude %}
        <div
          class="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-xl border border-gray-100 dark:border-gray-700 flex items-start gap-3">
          <div class="text-2xl">ğŸ“</div>
          <div>
            <p class="font-bold text-gray-800 dark:text-gray-200">Location Detected</p>
            <p class="text-sm text-gray-500 dark:text-gray-400 font-mono">{{ report.latitude }}, {{ report.longitude }}
            </p>
            <a href="https://www.google.com/maps?q={{ report.latitude }},{{ report.longitude }}" target="_blank"
              class="text-eco-600 dark:text-eco-400 text-sm font-bold hover:underline mt-1 inline-block">Open in
              Maps</a>
          </div>
        </div>
        {% endif %}

        <!-- ACTIONS -->
        {% if is_admin %}
        <div class="pt-8 border-t border-gray-100 dark:border-gray-700">
          <h3 class="text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-widest mb-4">Admin Controls
          </h3>

          <form method="post" class="space-y-4">
            {% csrf_token %}
            <div>
              <label class="block text-xs font-bold text-gray-500 mb-2">Assign/Change Worker</label>
              <div class="flex flex-col sm:flex-row gap-2">
                <select name="worker_id" required
                  class="flex-1 px-4 py-3 rounded-xl border-2 border-gray-100 dark:border-gray-700 bg-white dark:bg-gray-800 text-sm focus:border-eco-500 focus:ring-0 outline-none transition-all">
                  <option value="">{% if workers %}Select a professional...{% else %}No workers available{% endif %}
                  </option>
                  {% for worker in workers %}
                  <option value="{{ worker.id }}" {% if report.assigned_worker==worker %}selected{% endif %}>
                    {{ worker.get_full_name|default:worker.username }} (â­ {{ worker.average_rating|floatformat:1 }})
                  </option>
                  {% endfor %}
                </select>
                <button type="submit"
                  class="w-full sm:w-auto px-6 py-3 bg-eco-600 hover:bg-eco-700 text-white font-bold rounded-xl shadow-lg shadow-eco-500/20 transition-all flex items-center justify-center">
                  {% if report.assigned_worker %}Update{% else %}Assign{% endif %}
                </button>
              </div>
            </div>
          </form>

          <div class="mt-6 flex flex-col sm:flex-row gap-4">
            <a href="{% url 'edit_report' report.id %}"
              class="flex-1 text-center bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 py-3 rounded-xl font-bold transition text-sm">
              âœï¸ Edit Report
            </a>
            <a href="{% url 'delete_report' report.id %}"
              class="flex-1 text-center bg-red-50 hover:bg-red-100 text-red-600 py-3 rounded-xl font-bold transition border border-red-100 text-sm">
              ğŸ—‘ï¸ Delete Report
            </a>
          </div>
        </div>
        {% else %}
        {% if report.status == "pending" %}
        <div class="pt-8 border-t border-gray-100 dark:border-gray-700 flex flex-col sm:flex-row gap-4">
          <a href="{% url 'edit_report' report.id %}"
            class="flex-1 text-center bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 py-3 rounded-xl font-bold transition">
            âœï¸ Edit Report
          </a>
          <a href="{% url 'delete_report' report.id %}"
            class="flex-1 text-center bg-red-50 hover:bg-red-100 text-red-600 py-3 rounded-xl font-bold transition border border-red-100">
            ğŸ—‘ï¸ Delete Report
          </a>
        </div>
        {% elif report.status == "assigned" %}
        <div class="pt-8 border-t border-gray-100 dark:border-gray-700">
          <a href="{% url 'track_worker' report.id %}"
            class="w-full inline-flex items-center justify-center gap-3 bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-xl font-bold shadow-lg shadow-blue-500/30 transition-all hover:-translate-y-1">
            ğŸ“ Track Worker in Real-Time
          </a>
        </div>
        {% elif report.status == "resolved" %}
        <div class="pt-8 border-t border-gray-100 dark:border-gray-700">
          <div
            class="bg-green-50 dark:bg-green-900/30 border border-green-100 dark:border-green-800 p-4 rounded-xl flex items-center gap-3">
            <div class="p-2 bg-green-100 dark:bg-green-800 rounded-full text-green-600 dark:text-green-400">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
            </div>
            <div>
              <h4 class="font-bold text-green-900 dark:text-green-100">Issue Resolved</h4>
              <p class="text-sm text-green-700 dark:text-green-100">This report was marked as resolved on {{
                report.resolved_at|date:"M d, Y" }}.</p>
            </div>
          </div>
        </div>
        {% endif %}
        {% endif %}

      </div>

    </div>
  </div>

</div>
{% endblock %}