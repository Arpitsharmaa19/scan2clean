{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#15803d" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Scan2Clean" />

  <title>{% block title %}Scan2Clean{% endblock %}</title>

  <!-- Google Fonts: Outfit & Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;500;700;800&display=swap"
    rel="stylesheet">

  <!-- Tailwind CSS (Versioned CDN) -->
  <script src="https://cdn.tailwindcss.com/3.4.1"></script>

  <!-- Notification Sound Manager -->
  <script src="{% static 'js/notification-sound.js' %}"></script>
  <script src="{% static 'js/sound-toggle-ui.js' %}"></script>

  <!-- Dark Mode Logic -->
  <script>
    if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }

    async function toggleDarkMode() {
      const isDark = document.documentElement.classList.contains('dark');

      // Toggle UI immediately for smooth UX
      if (isDark) {
        document.documentElement.classList.remove('dark');
        localStorage.theme = 'light';
      } else {
        document.documentElement.classList.add('dark');
        localStorage.theme = 'dark';
      }

      // Save to database (async, non-blocking)
      try {
        const csrfToken = document.cookie.match(/csrftoken=([^;]+)/)?.[1];
        await fetch('/toggle-dark-mode/', {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
          }
        });
      } catch (err) {
        console.error('Failed to save dark mode preference:', err);
      }
    }
  </script>

  <!-- Tailwind Configuration -->
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
            heading: ['Outfit', 'sans-serif'],
          },
          colors: {
            eco: {
              50: '#f0fdf4',
              100: '#dcfce7',
              500: '#22c55e',
              600: '#16a34a',
              700: '#15803d',
              800: '#166534',
              900: '#14532d',
            },
            teal: {
              500: '#14b8a6',
              600: '#0d9488',
            },
            waste: {
              orange: '#f97316',
              red: '#ef4444',
            }
          },
          animation: {
            'fade-in': 'fadeIn 0.6s ease-out forwards',
            'fade-up': 'fadeUp 0.8s ease-out forwards',
            'fade-down': 'fadeDown 0.8s ease-out forwards',
            'slide-up': 'slideUp 0.6s ease-out forwards',
            'scale-in': 'scaleIn 0.4s ease-out forwards',
            'sway': 'sway 3s ease-in-out infinite',
            'float': 'float 4s ease-in-out infinite',
            'pulse-glow': 'pulseGlow 2s ease-in-out infinite',
            'shimmer': 'shimmer 2s linear infinite',
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' },
            },
            fadeUp: {
              '0%': { opacity: '0', transform: 'translateY(30px)' },
              '100%': { opacity: '1', transform: 'translateY(0)' },
            },
            fadeDown: {
              '0%': { opacity: '0', transform: 'translateY(-30px)' },
              '100%': { opacity: '1', transform: 'translateY(0)' },
            },
            sway: {
              '0%, 100%': { transform: 'rotate(-5deg)' },
              '50%': { transform: 'rotate(5deg)' },
            },
            float: {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-10px)' },
            },
            pulseGlow: {
              '0%, 100%': { opacity: '1', boxShadow: '0 0 20px rgba(34, 197, 94, 0.2)' },
              '50%': { opacity: '0.8', boxShadow: '0 0 40px rgba(34, 197, 94, 0.4)' },
            },
            shimmer: {
              '0%': { backgroundPosition: '-200% 0' },
              '100%': { backgroundPosition: '200% 0' },
            },
            slideUp: {
              '0%': { opacity: '0', transform: 'translateY(20px)' },
              '100%': { opacity: '1', transform: 'translateY(0)' },
            },
            scaleIn: {
              '0%': { opacity: '0', transform: 'scale(0.9)' },
              '100%': { opacity: '1', transform: 'scale(1)' },
            },
            holographicScan: {
              '0%': { top: '-10%', opacity: '0' },
              '10%': { opacity: '0.5' },
              '90%': { opacity: '0.5' },
              '100%': { top: '110%', opacity: '0' }
            },
            leafRustle: {
              '0%, 100%': { transform: 'rotate(0deg) translateY(0)' },
              '25%': { transform: 'rotate(2deg) translateY(-2px)' },
              '75%': { transform: 'rotate(-2deg) translateY(2px)' }
            }
          }
        }
      }
    }
  </script>

  <style>
    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    .dark ::-webkit-scrollbar-track {
      background: #1f2937;
    }

    ::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    .dark ::-webkit-scrollbar-thumb {
      background: #4b5563;
    }

    /* Glassmorphism Utilities */
    .glass {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .dark .glass {
      background: rgba(17, 24, 39, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
      border: 1px solid rgba(255, 255, 255, 0.18);
    }

    .dark .glass-card {
      background: rgba(31, 41, 55, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.05);
      color: #f3f4f6;
    }

    .shimmer-gradient {
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      background-size: 200% 100%;
    }

    /* üßä Elite Glassmorphism Spotlight */
    .spotlight-card {
      position: relative;
    }

    .spotlight-card::before {
      content: "";
      position: absolute;
      inset: -1px;
      border-radius: inherit;
      padding: 1px;
      background: radial-gradient(var(--spotlight-size, 400px) circle at var(--x, 0) var(--y, 0),
          rgba(255, 255, 255, 0.3),
          transparent 40%);
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.5s;
    }

    .spotlight-card:hover::before {
      opacity: 1;
    }

    /* ü¶¥ Skeleton Shimmer */
    .skeleton {
      background: linear-gradient(90deg,
          rgba(255, 255, 255, 0.05) 25%,
          rgba(255, 255, 255, 0.1) 50%,
          rgba(255, 255, 255, 0.05) 75%);
      background-size: 200% 100%;
      animation: skeleton-shimmer 2s infinite linear;
      border-radius: 0.5rem;
    }

    /* üî¨ Holographic Scanning Effect */
    .scan-beam {
      position: absolute;
      left: 0;
      right: 0;
      height: 100px;
      background: linear-gradient(to bottom, transparent, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.2), transparent);
      z-index: 5;
      pointer-events: none;
      animation: holographicScan 4s ease-in-out infinite;
    }

    .dark .scan-beam {
      background: linear-gradient(to bottom, transparent, rgba(34, 197, 94, 0.05), rgba(34, 197, 94, 0.15), transparent);
    }

    /* üß≤ Magnetic Magnetic Effect on Hover */
    .magnetic-card {
      transition: all 0.8s cubic-bezier(0.22, 1, 0.36, 1);
      will-change: transform, box-shadow;
    }

    .magnetic-card:hover {
      transform: translateY(-8px) scale(1.02) !important;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    }

    /* üçÉ Ambient Particles Canvas */
    #ambient-canvas {
      position: fixed;
      inset: 0;
      z-index: -5;
      pointer-events: none;
    }

    /* Interactive Star Rating */
    .star-rating {
      display: flex;
      flex-direction: row-reverse;
      gap: 0.25rem;
    }

    .star-rating input {
      display: none;
    }

    .star-rating label {
      cursor: pointer;
      font-size: 1.875rem;
      color: #e5e7eb;
      transition: all 0.2s ease;
    }

    .dark .star-rating label {
      color: #374151;
    }

    .star-rating input:checked~label,
    .star-rating label:hover,
    .star-rating label:hover~label {
      color: #facc15 !important;
      transform: scale(1.1);
    }

    /* Responsive Typography System */
    @media (max-width: 768px) {
      html {
        font-size: 14px;
      }

      .font-heading {
        letter-spacing: -0.02em;
      }
    }

    @media (max-width: 480px) {
      html {
        font-size: 12px;
      }
    }

    /* Native Mobile Feel */
    body {
      -webkit-tap-highlight-color: transparent;
      overscroll-behavior-y: none;
    }

    .pb-safe-area {
      padding-bottom: env(safe-area-inset-bottom);
    }

    /* Responsive Utilities */
    @media (max-width: 640px) {
      .responsive-p {
        padding: 1.25rem !important;
      }

      .responsive-rounded {
        border-radius: 1.25rem !important;
      }

      .responsive-text-title {
        font-size: 1.5rem !important;
      }
    }

    @media (min-width: 641px) and (max-width: 1024px) {
      .responsive-p {
        padding: 1.75rem !important;
      }

      .responsive-rounded {
        border-radius: 1.75rem !important;
      }

      .responsive-text-title {
        font-size: 2rem !important;
      }
    }

    /* Disable text selection on UI elements */
    nav,
    button,
    .glass-card h4 {
      user-select: none;
      -webkit-user-select: none;
    }
  </style>
</head>

<body
  class="text-gray-800 font-sans antialiased min-h-screen flex flex-col bg-gray-50 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-300">

  <!-- üçÉ Ambient Canvas -->
  <canvas id="ambient-canvas"></canvas>

  <script>
    // üßä Spotlight Logic
    document.addEventListener('mousemove', (e) => {
      document.querySelectorAll('.spotlight-card').forEach(card => {
        const rect = card.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        card.style.setProperty('--x', `${x}px`);
        card.style.setProperty('--y', `${y}px`);
      });
    });

    // üçÉ Particle System
    const canvas = document.getElementById('ambient-canvas');
    const ctx = canvas.getContext('2d');
    let particles = [];

    function resize() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }

    class Particle {
      constructor() {
        this.reset();
      }
      reset() {
        this.x = Math.random() * canvas.width;
        this.y = Math.random() * canvas.height;
        this.size = Math.random() * 4 + 1;
        this.speedX = Math.random() * 0.4 - 0.2;
        this.speedY = Math.random() * 0.4 - 0.2;
        this.opacity = Math.random() * 0.5;
        this.color = Math.random() > 0.5 ? 'rgba(34, 197, 94, ' : 'rgba(20, 184, 166, ';
      }
      update(mouseX, mouseY) {
        // Subtle Mouse Repulsion
        if (mouseX && mouseY) {
          const dx = this.x - mouseX;
          const dy = this.y - mouseY;
          const dist = Math.sqrt(dx * dx + dy * dy);
          if (dist < 150) {
            const force = (150 - dist) / 1500;
            this.x += dx * force;
            this.y += dy * force;
          }
        }

        this.x += this.speedX;
        this.y += this.speedY;
        if (this.x < 0 || this.x > canvas.width || this.y < 0 || this.y > canvas.height) this.reset();
      }
      draw() {
        ctx.fillStyle = this.color + `${this.opacity})`;
        ctx.beginPath();
        // Draw eco-shapes (circles and diamonds)
        if (this.size > 3) {
          ctx.moveTo(this.x, this.y - this.size);
          ctx.lineTo(this.x + this.size, this.y);
          ctx.lineTo(this.x, this.y + this.size);
          ctx.lineTo(this.x - this.size, this.y);
        } else {
          ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
        }
        ctx.fill();
      }
    }

    let mouse = { x: null, y: null };
    window.addEventListener('mousemove', (e) => {
      mouse.x = e.clientX;
      mouse.y = e.clientY;
    });

    function init() {
      particles = Array.from({ length: 60 }, () => new Particle());
      resize();
      animate();
    }

    function animate() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      particles.forEach(p => { p.update(mouse.x, mouse.y); p.draw(); });
      requestAnimationFrame(animate);
    }

    window.addEventListener('resize', resize);
    init();
  </script>

  <!-- üìä Chart.js & Elite Chart Global Config -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    if (typeof Chart !== 'undefined') {
      // Elite Global Defaults
      Chart.defaults.font.family = "'Outfit', sans-serif";
      Chart.defaults.color = 'rgba(156, 163, 175, 0.8)';
      Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(17, 24, 39, 0.9)';
      Chart.defaults.plugins.tooltip.padding = 12;
      Chart.defaults.plugins.tooltip.cornerRadius = 12;
      Chart.defaults.plugins.tooltip.titleFont = { size: 14, weight: 'bold' };

      // Custom Elite Animation Logic
      Chart.defaults.animation = {
        duration: 2000,
        easing: 'easeInOutQuart',
        onProgress: function (animation) {
          // Future hook for per-frame custom drawings if needed
        }
      };

      // Helper to create gradients
      function createChartGradient(ctx, color1, color2) {
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, color1);
        gradient.addColorStop(1, color2);
        return gradient;
      }
    }
  </script>

  <!-- üåü GLOBAL NAVBAR (Sticky Glass) -->
  <header class="fixed w-full top-0 z-50 glass shadow-sm transition-all duration-300">
    <div class="max-w-7xl mx-auto px-4 md:px-6 py-3 md:py-4 flex justify-between items-center">

      <!-- Logo -->
      <a href="/" class="flex items-center gap-1.5 md:gap-2 group">
        <div
          class="bg-gradient-to-br from-eco-500 to-teal-500 rounded-lg p-1 md:p-2 shadow-lg group-hover:scale-105 transition-transform duration-300">
          <span class="text-lg md:text-2xl">‚ôªÔ∏è</span>
        </div>
        <span
          class="text-lg md:text-2xl font-heading font-bold bg-clip-text text-transparent bg-gradient-to-r from-gray-800 to-gray-600 dark:from-white dark:to-gray-300">
          Scan<span class="text-eco-600">2Clean</span>
        </span>
      </a>

      <!-- Actions -->
      <div class="flex items-center gap-4">

        <!-- üåì Dark Mode Toggle -->
        <button onclick="toggleDarkMode()"
          class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition shadow-sm border border-gray-200 dark:border-gray-700">
          <!-- Sun (show in dark) -->
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-amber-500 hidden dark:block" fill="none"
            viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
          </svg>
          <!-- Moon (show in light) -->
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500 block dark:hidden" fill="none"
            viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
          </svg>
        </button>
        {% if user.is_authenticated %}
        <div class="hidden md:flex flex-col text-right mr-2">
          <span class="text-sm font-bold text-gray-700 dark:text-gray-200">{{ request.user.username }}</span>
          <span class="text-xs text-eco-600 uppercase tracking-wider font-semibold">{{ request.user.role }}</span>
        </div>
        <a href="{% url 'logout' %}" onclick="return confirm('‚ö†Ô∏è Are you sure you want to log out?');"
          class="px-4 py-2 rounded-full border border-red-200 text-red-500 hover:bg-red-50 hover:text-red-600 transition font-medium text-sm flex items-center gap-2">
          Logout
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
          </svg>
        </a>
        {% else %}
        <a href="{% url 'login' %}"
          class="text-gray-600 dark:text-gray-300 hover:text-eco-600 dark:hover:text-white font-bold transition-colors text-xs md:text-base">Login</a>
        <a href="{% url 'register' %}"
          class="bg-eco-600 text-white px-3 md:px-5 py-1.5 md:py-2.5 rounded-full hover:bg-eco-700 transition shadow-lg shadow-eco-500/30 font-black text-[10px] md:text-base uppercase tracking-tighter sm:tracking-normal">Register</a>
        {% endif %}
      </div>

    </div>
  </header>

  <!-- Spacer for fixed header -->
  <div class="h-20 md:h-24"></div>

  <!-- üçû GLOBAL TOAST CONTAINER -->
  <div id="toast-container"
    class="fixed bottom-8 right-8 z-[9999] flex flex-col gap-3 max-w-sm w-full pointer-events-none"></div>

  <style>
    .toast-enter {
      transform: translateX(100%);
      opacity: 0;
    }

    .toast-enter-active {
      transform: translateX(0);
      opacity: 1;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .toast-exit {
      transform: scale(0.9);
      opacity: 1;
    }

    .toast-exit-active {
      transform: scale(0.8);
      opacity: 0;
      transition: all 0.3s ease-in;
    }
  </style>

  <script>
    function showToast(title, message, level = 'info') {
      // üîä Play Sound using fancy manager if available
      if (window.playNotificationSound) {
        const soundMap = {
          'success': 'success',
          'error': 'error',
          'warning': 'alert',
          'info': 'message'
        };
        window.playNotificationSound(soundMap[level] || 'message');
      }

      const container = document.getElementById('toast-container');
      if (!container) return;
      const toast = document.createElement('div');

      const colors = {
        info: 'bg-blue-600',
        success: 'bg-green-600',
        warning: 'bg-amber-500',
        error: 'bg-red-600'
      };

      const icons = {
        info: 'üîµ',
        success: '‚úÖ',
        warning: '‚ö†Ô∏è',
        error: '‚ùå'
      };

      toast.className = `pointer-events-auto w-full glass-card p-4 rounded-2xl shadow-2xl border-l-4 ${colors[level].replace('bg-', 'border-')} flex items-start gap-4 toast-enter bg-white/90 dark:bg-gray-800/90 backdrop-blur-md border border-white/40 dark:border-gray-700/40`;

      toast.innerHTML = `
        <div class="text-2xl">${icons[level]}</div>
        <div class="flex-1">
          <h4 class="font-bold text-gray-800 dark:text-gray-100 text-sm">${title}</h4>
          <p class="text-xs text-gray-600 dark:text-gray-400 mt-0.5 leading-tight">${message}</p>
        </div>
        <button class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" onclick="this.parentElement.remove()">‚úï</button>
      `;

      container.appendChild(toast);

      requestAnimationFrame(() => {
        toast.classList.replace('toast-enter', 'toast-enter-active');
      });

      setTimeout(() => {
        toast.classList.replace('toast-enter-active', 'toast-exit-active');
        setTimeout(() => toast.remove(), 300);
      }, 6000);
    }
  </script>

  <!-- Content -->
  <main class="flex-grow w-full">
    {% block content %}{% endblock %}
  </main>

  <!-- Footer -->
  <footer class="bg-gray-900 text-gray-400 py-8 text-center text-sm">
    <p>&copy; 2024 Scan2Clean. Building a cleaner future.</p>
  </footer>

  {% block extra_js %}{% endblock %}
</body>

</html>