{% extends "dashboards/base_dashboard.html" %}
{% load static %}

{% block title %}Global Waste Map{% endblock %}

{% block dashboard_content %}

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

<style>
  /* üåà Snap-map Aesthetics */
  .modern-popup .leaflet-popup-content-wrapper {
    border-radius: 24px;
    padding: 0;
    overflow: hidden;
    box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.4);
  }

  .dark .modern-popup .leaflet-popup-content-wrapper {
    background: rgba(17, 24, 39, 0.9);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .modern-popup .leaflet-popup-content {
    margin: 0;
    width: 240px !important;
  }

  .modern-popup .leaflet-popup-tip {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
  }

  .dark .modern-popup .leaflet-popup-tip {
    background: rgba(17, 24, 39, 0.9);
  }

  .cluster-icon div {
    transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }

  .cluster-icon:hover div {
    transform: scale(1.15);
  }

  /* Heatmap Transition */
  #map canvas {
    transition: opacity 0.8s ease;
  }

  .marker-pulse:hover div {
    transform: scale(1.3);
  }
</style>

<!-- ü¶¥ Skeleton Loading Overlay -->
<div id="dashboard-skeleton"
  class="fixed inset-0 z-[60] bg-gray-50 dark:bg-gray-900 overflow-hidden pointer-events-none transition-opacity duration-700 p-8">
  <div class="max-w-7xl mx-auto space-y-8">
    <div class="h-16 w-full skeleton rounded-xl"></div>
    <div class="h-[700px] w-full skeleton rounded-3xl"></div>
  </div>
</div>

<script>
  window.addEventListener('load', () => {
    const skeleton = document.getElementById('dashboard-skeleton');
    if (skeleton) {
      skeleton.style.opacity = '0';
      setTimeout(() => skeleton.remove(), 700);
    }
  });
</script>

<div style="height: calc(100vh - 8rem);" class="flex flex-col animate-fade-up">

  <!-- üõ†Ô∏è Map Controls Header -->
  <div class="glass-card p-3 md:p-4 rounded-xl shadow-lg mb-4 flex flex-col items-center justify-between gap-3 z-10">

    <div class="flex items-center justify-between w-full md:w-auto gap-4">
      <div class="flex items-center gap-2">
        <h1 class="text-sm md:text-xl font-bold text-gray-800 dark:text-gray-100 uppercase tracking-tight">üåç Global Map
        </h1>
      </div>

      <!-- Map Mode Toggle (Mobile) -->
      <div
        class="flex md:hidden bg-gray-100 dark:bg-gray-700/50 rounded-full p-1 border border-gray-200 dark:border-gray-700 shadow-inner">
        <button onclick="setMode('markers')" id="btn-markers-mob"
          class="p-2 rounded-full text-xs transition-all">üìç</button>
        <button onclick="setMode('heatmap')" id="btn-heatmap-mob"
          class="p-2 rounded-full text-xs transition-all">üî•</button>
      </div>
    </div>

    <!-- Filters Form -->
    <form method="get"
      class="flex flex-wrap md:flex-nowrap gap-2 items-center text-xs w-full justify-center md:justify-end">
      <select name="days" onchange="this.form.submit()"
        class="flex-1 md:flex-none border border-gray-200 dark:border-gray-700 rounded-lg px-2 py-2 bg-gray-50 dark:bg-gray-800 text-[10px] font-bold">
        <option value="">üìÖ All Time</option>
        <option value="1">Last 24h</option>
        <option value="7">Last 7d</option>
      </select>
      <select name="status" onchange="this.form.submit()"
        class="flex-1 md:flex-none border border-gray-200 dark:border-gray-700 rounded-lg px-2 py-2 bg-gray-50 dark:bg-gray-800 text-[10px] font-bold">
        <option value="">üìå All Status</option>
        <option value="pending">Pending</option>
        <option value="assigned">Assigned</option>
      </select>
      <a href="{% url 'waste_map' %}" class="text-gray-400 hover:text-red-500 px-2 font-black text-[10px]">‚úï</a>
    </form>

    <!-- Map Mode Toggle (Desktop) -->
    <div
      class="hidden md:flex bg-gray-100 dark:bg-gray-700/50 rounded-full p-1 border border-gray-200 dark:border-gray-700 shadow-inner">
      <button onclick="setMode('markers')" id="btn-markers"
        class="px-4 py-2 rounded-full text-xs font-black transition-all duration-300 flex items-center gap-2 bg-white dark:bg-eco-600 text-eco-600 dark:text-white">üìç
        Markers</button>
      <button onclick="setMode('heatmap')" id="btn-heatmap"
        class="px-4 py-2 rounded-full text-xs font-black transition-all duration-300 flex items-center gap-2 text-gray-500 hover:text-orange-500">üî•
        Heatmap</button>
    </div>

  </div>

  <!-- üó∫Ô∏è Map Container -->
  <div
    class="relative flex-grow rounded-3xl overflow-hidden shadow-2xl border border-gray-200 dark:border-gray-700 group">
    <div id="map" class="absolute inset-0 z-0 bg-[#f8f9fa] dark:bg-gray-900 transition-opacity duration-500"></div>

    <!-- üè∑Ô∏è Map Flair Overlay (Snap-map style) -->
    <div class="absolute top-6 left-6 z-[1000] pointer-events-none flex flex-col gap-2">
      <div
        class="bg-white/90 dark:bg-gray-900/90 backdrop-blur-md px-3 py-1.5 rounded-full shadow-lg border border-white/20 flex items-center gap-2">
        <span class="h-2 w-2 rounded-full bg-green-500 animate-pulse"></span>
        <span class="text-[10px] font-black text-gray-800 dark:text-white uppercase tracking-widest">Live
          Monitoring</span>
      </div>
    </div>

    <!-- Floating 'My Location' Button -->
    <button onclick="locateUser()"
      class="absolute bottom-6 right-6 z-[1000] bg-white dark:bg-gray-800 p-4 rounded-full shadow-2xl hover:bg-eco-50 dark:hover:bg-gray-700 hover:scale-110 active:scale-95 transition-all text-eco-600 dark:text-eco-400 ring-4 ring-white/20"
      title="My Location">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
      </svg>
    </button>
  </div>

</div>

<!-- Libraries -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

{{ reports|json_script:"reports-data" }}
<script>
  const reports = JSON.parse(document.getElementById('reports-data').textContent);

  // --- Map Init ---
  const map = L.map("map", {
    zoomControl: false,
    scrollWheelZoom: true
  }).setView([20.5937, 78.9629], 5);

  L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
    attribution: "¬© CartoDB"
  }).addTo(map);

  // --- Layers ---
  const markersLayer = L.markerClusterGroup({
    spiderfyOnMaxZoom: true,
    showCoverageOnHover: false,
    iconCreateFunction: function (cluster) {
      return L.divIcon({
        html: `<div class="bg-eco-600 text-white rounded-full flex items-center justify-center font-bold border-4 border-white shadow-lg text-xs" style="width:36px;height:36px;">${cluster.getChildCount()}</div>`,
        className: 'cluster-icon',
        iconSize: L.point(36, 36)
      });
    }
  });
  let heatLayer = null;

  // --- Icons ---
  function getIcon(severity) {
    let color = "#22c55e"; // low
    if (severity === "High") color = "#ef4444";
    else if (severity === "Medium") color = "#f59e0b";

    return L.divIcon({
      html: `<div style="background:${color};width:20px;height:20px;border-radius:50%;border:3px solid white;box-shadow:0 4px 15px rgba(0,0,0,0.2); transition: transform 0.3s ease;"></div>`,
      className: 'marker-pulse'
    });
  }

  // --- Render Markers ---
  function renderMarkers() {
    markersLayer.clearLayers();
    if (heatLayer) map.removeLayer(heatLayer);

    reports.forEach(r => {
      const popup = `
        <div class="w-56 p-2">
          <div class="relative h-32 mb-3 overflow-hidden rounded-2xl shadow-inner">
            ${r.image ? `<img src="${r.image}" class="w-full h-full object-cover">` : '<div class="w-full h-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center">üì∏</div>'}
            <div class="absolute top-2 right-2 bg-white/90 dark:bg-gray-900/90 text-[10px] px-2 py-1 rounded-full font-black uppercase text-eco-600 shadow-sm">
              ${r.waste_type}
            </div>
          </div>
          <div class="mb-3 space-y-1">
            <h4 class="text-xs font-black text-gray-400 uppercase tracking-widest leading-none">${r.severity} Severity</h4>
            <p class="text-[10px] text-gray-500 font-bold">${r.created_at}</p>
          </div>
          <a href="${r.detail_url}" class="block w-full text-center bg-eco-600 hover:bg-eco-700 text-white text-[10px] font-black uppercase tracking-widest py-2.5 rounded-xl transition-all shadow-lg shadow-eco-500/20 active:scale-95">Open Report</a>
        </div>
      `;
      const m = L.marker([r.lat, r.lng], { icon: getIcon(r.severity) }).bindPopup(popup, {
        className: 'modern-popup',
        maxWidth: 240
      });
      markersLayer.addLayer(m);
    });

    map.addLayer(markersLayer);

    // Fit bounds if markers exist
    if (markersLayer.getLayers().length) {
      map.fitBounds(markersLayer.getBounds(), { padding: [50, 50] });
    }
  }

  // --- Render Heatmap ---
  function renderHeatmap() {
    map.removeLayer(markersLayer);

    if (!heatLayer) {
      const points = reports.map(r => {
        let intensity = 0.5;
        if (r.severity === 'High') intensity = 1.0;
        else if (r.severity === 'Medium') intensity = 0.8;
        return [r.lat, r.lng, intensity];
      });

      heatLayer = L.heatLayer(points, {
        radius: 35,
        blur: 25,
        maxOpacity: 0.85,
        max: 1.0,
        gradient: {
          0.0: '#00ffff', // Cyan
          0.2: '#00ff00', // Green
          0.4: '#ffff00', // Yellow
          0.6: '#ffa500', // Orange
          1.0: '#ff0000'  // Red
        }
      });
    }

    map.addLayer(heatLayer);

    // Zoom out slightly to see the patterns
    if (reports.length > 0) {
      const bounds = L.latLngBounds(reports.map(r => [r.lat, r.lng]));
      map.fitBounds(bounds, { padding: [100, 100], maxZoom: 14 });
    }
  }

  // --- Toggle Mode ---
  function setMode(mode) {
    const btnM = document.getElementById('btn-markers');
    const btnH = document.getElementById('btn-heatmap');

    if (mode === 'markers') {
      btnM.className = "px-4 py-2 rounded-full text-xs font-black transition-all duration-300 flex items-center gap-2 bg-white dark:bg-eco-600 text-eco-600 dark:text-white shadow-sm ring-1 ring-black/5";
      btnH.className = "px-4 py-2 rounded-full text-xs font-black transition-all duration-300 flex items-center gap-2 text-gray-500 dark:text-gray-400 hover:text-orange-500";
      renderMarkers();
    } else {
      btnH.className = "px-4 py-2 rounded-full text-xs font-black transition-all duration-300 flex items-center gap-2 bg-white dark:bg-orange-600 text-orange-600 dark:text-white shadow-sm ring-1 ring-black/5";
      btnM.className = "px-4 py-2 rounded-full text-xs font-black transition-all duration-300 flex items-center gap-2 text-gray-500 dark:text-gray-400 hover:text-eco-600";
      renderHeatmap();
    }
  }

  // --- Locate User ---
  function locateUser() {
    if (navigator.geolocation) {
      const btn = event.currentTarget;
      const originalContent = btn.innerHTML;
      btn.innerHTML = '‚åõ'; // Loading state

      navigator.geolocation.getCurrentPosition(
        pos => {
          btn.innerHTML = originalContent;
          const { latitude, longitude } = pos.coords;
          map.setView([latitude, longitude], 14);
          L.marker([latitude, longitude]).addTo(map).bindPopup("You are here").openPopup();
        },
        err => {
          btn.innerHTML = originalContent;
          console.error("Locate error:", err);
          let msg = "Could not determine location.";
          if (err.code === 1) msg = "Location permission denied.";
          else if (err.code === 3) msg = "Location request timed out.";
          alert(msg);
        },
        { timeout: 10000, enableHighAccuracy: true }
      );
    } else {
      alert("Geolocation is not supported by this browser.");
    }
  }

  // Default Init
  renderMarkers();

</script>
{% endblock %}