{% extends "dashboards/base_dashboard.html" %}
{% block title %}Analytics Dashboard{% endblock %}

{% block dashboard_content %}

<!-- ğŸ¦´ Skeleton Loading Overlay -->
<div id="dashboard-skeleton"
  class="fixed inset-0 z-[60] bg-gray-50 dark:bg-gray-900 overflow-hidden pointer-events-none transition-opacity duration-700 p-8">
  <div class="max-w-7xl mx-auto space-y-8">
    <div class="h-20 w-80 skeleton rounded-xl"></div>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
      <div class="h-32 skeleton rounded-2xl"></div>
      <div class="h-32 skeleton rounded-2xl"></div>
      <div class="h-32 skeleton rounded-2xl"></div>
      <div class="h-32 skeleton rounded-2xl"></div>
    </div>
    <div class="h-96 w-full skeleton rounded-3xl"></div>
  </div>
</div>

<script>
  window.addEventListener('load', () => {
    const skeleton = document.getElementById('dashboard-skeleton');
    if (skeleton) {
      skeleton.style.opacity = '0';
      setTimeout(() => skeleton.remove(), 700);
    }
  });
</script>

<!-- ğŸŒˆ Header -->
<div
  class="relative rounded-3xl p-8 text-white mb-10 overflow-hidden shadow-2xl animate-fade-down group spotlight-card bg-gradient-to-r from-gray-800 to-gray-900 border border-white/10">
  <div class="scan-beam"></div>
  <div class="relative z-10">
    <h1 class="text-3xl font-heading font-bold text-white flex items-center gap-3">
      <span class="animate-sway">ğŸ“Š</span> Analytics Command Center
    </h1>
    <p class="text-gray-300 mt-1 font-medium italic opacity-80">Deep dive into waste reporting trends & ecological
      impact.</p>
  </div>
  <div class="absolute -right-4 -bottom-4 text-8xl opacity-10 transform rotate-12">ğŸ’</div>
</div>

<!-- ğŸ“ˆ KPI Cards -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-10 animate-fade-up">

  <!-- Total -->
  <div class="glass-card spotlight-card magnetic-card rounded-2xl p-6 shadow-lg border-l-4 border-indigo-500">
    <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Total Reports</p>
    <p class="text-4xl font-heading font-bold text-gray-800 dark:text-white">{{ total_reports }}</p>
  </div>

  <!-- Pending -->
  <div class="glass-card spotlight-card magnetic-card rounded-2xl p-6 shadow-lg border-l-4 border-yellow-400">
    <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Pending</p>
    <p class="text-4xl font-heading font-bold text-yellow-500">{{ pending_count|default:"-" }}</p>
  </div>

  <!-- Resolved -->
  <div class="glass-card spotlight-card magnetic-card rounded-2xl p-6 shadow-lg border-l-4 border-green-500">
    <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Resolved</p>
    <p class="text-4xl font-heading font-bold text-green-600">{{ resolved_count|default:"-" }}</p>
  </div>

  <!-- Efficiency -->
  <div class="glass-card spotlight-card magnetic-card rounded-2xl p-6 shadow-lg border-l-4 border-orange-500">
    <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Efficiency Ratio</p>
    <p class="text-4xl font-heading font-bold text-orange-500">Optimum</p>
  </div>

</div>

<!-- ğŸ“Š Charts Section -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-10 animate-fade-up delay-100">

  <!-- Daily Reports Trend -->
  <div
    class="glass-card spotlight-card magnetic-card rounded-2xl p-6 shadow-xl col-span-1 lg:col-span-2 relative overflow-hidden">
    <div class="scan-beam" style="animation-duration: 6s; opacity: 0.2;"></div>
    <h3 class="text-lg font-bold text-gray-700 dark:text-gray-200 mb-6 flex items-center gap-2">
      <span class="p-2 bg-blue-100 dark:bg-blue-900/30 text-blue-600 rounded-lg">ğŸ“ˆ</span> Reporting Trend (Last 7 Days)
    </h3>
    <div class="relative h-72 w-full">
      <canvas id="dailyTrendChart"></canvas>
    </div>
  </div>

  <!-- Status Distribution -->
  <div class="glass-card spotlight-card magnetic-card rounded-2xl p-6 shadow-xl">
    <h3 class="text-lg font-bold text-gray-700 dark:text-gray-200 mb-6 flex items-center gap-2">
      <span class="p-2 bg-yellow-100 dark:bg-yellow-900/30 text-yellow-600 rounded-lg">ğŸ“Š</span> Status Breakdown
    </h3>
    <div class="relative h-64 flex justify-center">
      <canvas id="statusChart"></canvas>
    </div>
  </div>

  <!-- Waste Type -->
  <div class="glass-card spotlight-card magnetic-card rounded-2xl p-6 shadow-xl">
    <h3 class="text-lg font-bold text-gray-700 dark:text-gray-200 mb-6 flex items-center gap-2">
      <span class="p-2 bg-eco-100 dark:bg-eco-900/30 text-eco-600 rounded-lg">ğŸ—‘ï¸</span> Waste Types
    </h3>
    <div class="relative h-64 flex justify-center">
      <canvas id="wasteTypeChart"></canvas>
    </div>
  </div>

  <!-- Severity -->
  <div class="glass-card spotlight-card magnetic-card rounded-2xl p-6 shadow-xl leading-relaxed">
    <h3 class="text-lg font-bold text-gray-700 dark:text-gray-200 mb-6 flex items-center gap-2">
      <span class="p-2 bg-red-100 dark:bg-red-900/30 text-red-600 rounded-lg">âš ï¸</span> Severity Analysis
    </h3>
    <div class="relative h-64 flex justify-center">
      <canvas id="severityChart"></canvas>
    </div>
  </div>

</div>

<script>
  // Parse Data from Django
  const statusData = JSON.parse('{{ status_counts|safe }}');
  const severityData = JSON.parse('{{ severity_counts|safe }}');
  const wasteTypeData = JSON.parse('{{ waste_type_counts|safe }}');
  const dailyData = JSON.parse('{{ daily_reports|safe }}');

  // Colors
  const colors = {
    green: '#22c55e', yellow: '#facc15', orange: '#f97316',
    blue: '#3b82f6', red: '#ef4444', purple: '#a855f7'
  };

  /* --- 1. Daily Trend Chart --- */
  const trendCtx = document.getElementById('dailyTrendChart').getContext('2d');
  new Chart(trendCtx, {
    type: 'line',
    data: {
      labels: dailyData.map(d => new Date(d.day).toLocaleDateString('en-US', { weekday: 'short' })),
      datasets: [{
        label: 'Reports',
        data: dailyData.map(d => d.count),
        borderColor: colors.blue,
        backgroundColor: createChartGradient(trendCtx, 'rgba(59, 130, 246, 0.4)', 'transparent'),
        fill: true,
        tension: 0.4,
        pointBackgroundColor: colors.blue,
        pointRadius: 4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      animation: {
        x: { type: 'number', easing: 'linear', duration: 0, from: 0 },
        y: { type: 'number', easing: 'easeOutElastic', duration: 2000, from: 500 }
      },
      scales: {
        y: { beginAtZero: true, grid: { borderDash: [4, 4], color: 'rgba(156, 163, 175, 0.1)' } },
        x: { grid: { display: false } }
      }
    }
  });

  /* --- 2. Status Chart (Doughnut) --- */
  new Chart(document.getElementById('statusChart'), {
    type: 'doughnut',
    data: {
      labels: statusData.map(d => d.status.charAt(0).toUpperCase() + d.status.slice(1)),
      datasets: [{
        data: statusData.map(d => d.count),
        backgroundColor: [colors.yellow, colors.blue, colors.green],
        borderWidth: 0,
        hoverOffset: 15
      }]
    },
    options: {
      cutout: '70%',
      plugins: { legend: { position: 'right' } },
      animation: {
        animateRotate: true,
        animateScale: true,
        duration: 2500,
        easing: 'easeOutElastic'
      }
    }
  });

  /* --- 3. Waste Type Chart (Polar Area) --- */
  new Chart(document.getElementById('wasteTypeChart'), {
    type: 'polarArea',
    data: {
      labels: wasteTypeData.map(d => d.waste_type),
      datasets: [{
        data: wasteTypeData.map(d => d.count),
        backgroundColor: [
          'rgba(34, 197, 94, 0.7)',
          'rgba(249, 115, 22, 0.7)',
          'rgba(239, 68, 68, 0.7)',
          'rgba(59, 130, 246, 0.7)',
          'rgba(168, 85, 247, 0.7)'
        ],
        borderWidth: 1
      }]
    },
    options: {
      scales: { r: { ticks: { display: false }, grid: { color: 'rgba(156, 163, 175, 0.1)' } } },
      plugins: { legend: { position: 'right' } },
      animation: {
        duration: 2500,
        easing: 'easeOutQuart'
      }
    }
  });

  /* --- 4. Severity (Bar) --- */
  const sevCtx = document.getElementById('severityChart').getContext('2d');
  new Chart(sevCtx, {
    type: 'bar',
    data: {
      labels: severityData.map(d => d.severity.charAt(0).toUpperCase() + d.severity.slice(1)),
      datasets: [{
        label: 'Reports',
        data: severityData.map(d => d.count),
        backgroundColor: [
          createChartGradient(sevCtx, colors.green, '#15803d'),
          createChartGradient(sevCtx, colors.yellow, '#a16207'),
          createChartGradient(sevCtx, colors.red, '#b91c1c')
        ],
        borderRadius: 12
      }]
    },
    options: {
      plugins: { legend: { display: false } },
      animation: {
        duration: 2000,
        easing: 'easeOutElastic',
        delay: (context) => context.dataIndex * 200
      },
      scales: {
        y: { beginAtZero: true, grid: { color: 'rgba(156, 163, 175, 0.1)' } },
        x: { grid: { display: false } }
      }
    }
  });
</script>

{% endblock %}