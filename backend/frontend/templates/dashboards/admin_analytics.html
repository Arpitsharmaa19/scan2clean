{% extends "dashboards/base_dashboard.html" %}
{% block title %}Analytics Dashboard{% endblock %}

{% block dashboard_content %}

<!-- Header -->
<div class="mb-8 animate-fade-up">
  <h1 class="text-3xl font-heading font-bold text-gray-800">ğŸ“Š Analytics Dashboard</h1>
  <p class="text-gray-500 mt-1">Deep dive into waste reporting trends and statistics.</p>
</div>

<!-- ğŸ“ˆ KPI Cards -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-10 animate-fade-up">

  <!-- Total -->
  <div class="glass-card rounded-2xl p-6 shadow-lg border-l-4 border-indigo-500">
    <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Total Reports</p>
    <p class="text-4xl font-heading font-bold text-gray-800">{{ total_reports }}</p>
  </div>

  <!-- Pending -->
  <div class="glass-card rounded-2xl p-6 shadow-lg border-l-4 border-yellow-400">
    <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Pending</p>
    <p class="text-4xl font-heading font-bold text-yellow-500">{{ pending_count|default:"-" }}</p>
  </div>

  <!-- Resolved -->
  <div class="glass-card rounded-2xl p-6 shadow-lg border-l-4 border-green-500">
    <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Resolved</p>
    <p class="text-4xl font-heading font-bold text-green-600">{{ resolved_count|default:"-" }}</p>
  </div>

  <!-- Efficiency (Placeholder/Calc) -->
  <div class="glass-card rounded-2xl p-6 shadow-lg border-l-4 border-orange-500">
    <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Efficiency</p>
    <p class="text-4xl font-heading font-bold text-orange-500">High</p>
  </div>

</div>

<!-- ğŸ“Š Charts Section -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-10 animate-fade-up delay-100">

  <!-- Daily Reports Trend -->
  <div class="glass-card rounded-2xl p-6 shadow-xl col-span-1 lg:col-span-2">
    <h3 class="text-lg font-bold text-gray-700 mb-6 flex items-center gap-2">
      <span class="p-2 bg-blue-100 text-blue-600 rounded-lg">ğŸ“ˆ</span> Reporting Trend (Last 7 Days)
    </h3>
    <div class="relative h-72 w-full">
      <canvas id="dailyTrendChart"></canvas>
    </div>
  </div>

  <!-- Status Distribution -->
  <div class="glass-card rounded-2xl p-6 shadow-xl">
    <h3 class="text-lg font-bold text-gray-700 mb-6 flex items-center gap-2">
      <span class="p-2 bg-yellow-100 text-yellow-600 rounded-lg">ğŸ“Š</span> Status Breakdown
    </h3>
    <div class="relative h-64 flex justify-center">
      <canvas id="statusChart"></canvas>
    </div>
  </div>

  <!-- Waste Type -->
  <div class="glass-card rounded-2xl p-6 shadow-xl">
    <h3 class="text-lg font-bold text-gray-700 mb-6 flex items-center gap-2">
      <span class="p-2 bg-eco-100 text-eco-600 rounded-lg">ğŸ—‘ï¸</span> Waste Types
    </h3>
    <div class="relative h-64 flex justify-center">
      <canvas id="wasteTypeChart"></canvas>
    </div>
  </div>

  <!-- Severity -->
  <div class="glass-card rounded-2xl p-6 shadow-xl leading-relaxed">
    <h3 class="text-lg font-bold text-gray-700 mb-6 flex items-center gap-2">
      <span class="p-2 bg-red-100 text-red-600 rounded-lg">âš ï¸</span> Severity Analysis
    </h3>
    <div class="relative h-64 flex justify-center">
      <canvas id="severityChart"></canvas>
    </div>
  </div>

</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Parse Data from Django
  const statusData = JSON.parse('{{ status_counts|safe }}');
  const severityData = JSON.parse('{{ severity_counts|safe }}');
  const wasteTypeData = JSON.parse('{{ waste_type_counts|safe }}');
  const dailyData = JSON.parse('{{ daily_reports|safe }}');

  // Colors
  const colors = {
    green: '#22c55e', yellow: '#facc15', orange: '#f97316',
    blue: '#3b82f6', red: '#ef4444', purple: '#a855f7'
  };

  /* --- 1. Daily Trend Chart --- */
  new Chart(document.getElementById('dailyTrendChart'), {
    type: 'line',
    data: {
      labels: dailyData.map(d => new Date(d.day).toLocaleDateString('en-US', { weekday: 'short' })),
      datasets: [{
        label: 'Reports',
        data: dailyData.map(d => d.count),
        borderColor: colors.blue,
        backgroundColor: 'rgba(59, 130, 246, 0.1)',
        fill: true,
        tension: 0.4,
        pointBackgroundColor: colors.blue,
        pointRadius: 4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, grid: { borderDash: [4, 4] } },
        x: { grid: { display: false } }
      }
    }
  });

  /* --- 2. Status Chart (Doughnut) --- */
  new Chart(document.getElementById('statusChart'), {
    type: 'doughnut',
    data: {
      labels: statusData.map(d => d.status.charAt(0).toUpperCase() + d.status.slice(1)),
      datasets: [{
        data: statusData.map(d => d.count),
        backgroundColor: [colors.yellow, colors.blue, colors.green],
        borderWidth: 0,
        hoverOffset: 10
      }]
    },
    options: {
      cutout: '70%',
      plugins: { legend: { position: 'right' } }
    }
  });

  /* --- 3. Waste Type Chart (Polar Area) --- */
  new Chart(document.getElementById('wasteTypeChart'), {
    type: 'polarArea',
    data: {
      labels: wasteTypeData.map(d => d.waste_type),
      datasets: [{
        data: wasteTypeData.map(d => d.count),
        backgroundColor: [
          'rgba(34, 197, 94, 0.7)',
          'rgba(249, 115, 22, 0.7)',
          'rgba(239, 68, 68, 0.7)',
          'rgba(59, 130, 246, 0.7)',
          'rgba(168, 85, 247, 0.7)'
        ],
        borderWidth: 1
      }]
    },
    options: {
      scales: { r: { ticks: { backdropColor: 'transparent' } } },
      plugins: { legend: { position: 'right' } }
    }
  });

  /* --- 4. Severity (Bar) --- */
  new Chart(document.getElementById('severityChart'), {
    type: 'bar',
    data: {
      labels: severityData.map(d => d.severity.charAt(0).toUpperCase() + d.severity.slice(1)),
      datasets: [{
        label: 'Reports',
        data: severityData.map(d => d.count),
        backgroundColor: [colors.green, colors.yellow, colors.red],
        borderRadius: 8
      }]
    },
    options: {
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true },
        x: { grid: { display: false } }
      }
    }
  });
</script>

{% endblock %}