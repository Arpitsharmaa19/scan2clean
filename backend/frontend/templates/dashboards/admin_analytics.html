{% extends "dashboards/base_dashboard.html" %}
{% block title %}Analytics Dashboard{% endblock %}

{% block dashboard_content %}

<!-- ğŸ¦´ Skeleton Loading Overlay -->
<div id="dashboard-skeleton"
  class="fixed inset-0 z-[60] bg-gray-50 dark:bg-gray-900 overflow-hidden pointer-events-none transition-opacity duration-700 p-8">
  <div class="max-w-7xl mx-auto space-y-8">
    <div class="h-20 w-80 skeleton rounded-xl"></div>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
      <div class="h-32 skeleton rounded-2xl"></div>
      <div class="h-32 skeleton rounded-2xl"></div>
      <div class="h-32 skeleton rounded-2xl"></div>
      <div class="h-32 skeleton rounded-2xl"></div>
    </div>
    <div class="h-96 w-full skeleton rounded-3xl"></div>
  </div>
</div>

<script>
  window.addEventListener('load', () => {
    const skeleton = document.getElementById('dashboard-skeleton');
    if (skeleton) {
      skeleton.style.opacity = '0';
      setTimeout(() => skeleton.remove(), 700);
    }
  });
</script>

<!-- ğŸŒˆ Header -->
<div
  class="relative rounded-2xl md:rounded-3xl p-6 md:p-8 text-white mb-6 md:mb-10 overflow-hidden shadow-2xl animate-fade-down group spotlight-card bg-gradient-to-r from-gray-800 to-gray-900 border border-white/10">
  <div class="scan-beam"></div>
  <div class="relative z-10 text-center md:text-left">
    <h1
      class="text-2xl md:text-3xl font-heading font-bold text-white flex items-center justify-center md:justify-start gap-3">
      <span class="animate-sway">ğŸ“Š</span> Analytics Command Center
    </h1>
    <p class="text-gray-300 mt-1 font-medium italic opacity-80">Deep dive into waste reporting trends & ecological
      impact.</p>
  </div>
  <div class="absolute -right-4 -bottom-4 text-8xl opacity-10 transform rotate-12">ğŸ’</div>
</div>

<!-- ğŸ“ˆ KPI Cards -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">

  <!-- Total -->
  <div
    class="glass-card spotlight-card magnetic-card rounded-2xl p-6 shadow-lg border-l-4 border-indigo-500 cursor-default">
    <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Total Reports</p>
    <p class="text-4xl font-heading font-bold text-gray-800 dark:text-white">{{ total_reports }}</p>
  </div>

  <!-- Pending -->
  <div
    class="glass-card spotlight-card magnetic-card rounded-2xl p-6 shadow-lg border-l-4 border-amber-400 cursor-default">
    <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Pending</p>
    <p class="text-4xl font-heading font-bold text-amber-500">{{ pending_count|default:"-" }}</p>
  </div>

  <!-- Resolved -->
  <div
    class="glass-card spotlight-card magnetic-card rounded-2xl p-6 shadow-lg border-l-4 border-green-500 cursor-default">
    <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Resolved</p>
    <p class="text-4xl font-heading font-bold text-green-600">{{ resolved_count|default:"-" }}</p>
  </div>

  <!-- Efficiency -->
  <div
    class="glass-card spotlight-card magnetic-card rounded-2xl p-6 shadow-lg border-l-4 border-orange-500 cursor-default">
    <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Efficiency Ratio</p>
    <p class="text-4xl font-heading font-bold text-orange-500">{{ efficiency_rate }}</p>
  </div>

</div>

<!-- ğŸ“Š Charts Section -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-10 animate-fade-up delay-100">

  <!-- Daily Reports Trend -->
  <div
    class="glass-card spotlight-card magnetic-card rounded-2xl p-6 shadow-xl col-span-1 lg:col-span-2 relative overflow-hidden">
    <div class="scan-beam" style="animation-duration: 6s; opacity: 0.2;"></div>
    <h3 class="text-lg font-bold text-gray-700 dark:text-gray-200 mb-6 flex items-center gap-2">
      <span class="p-2 bg-blue-100 dark:bg-blue-900/30 text-blue-600 rounded-lg">ğŸ“ˆ</span> Reporting Trend (Last 7 Days)
    </h3>
    <div class="relative h-72 w-full">
      <canvas id="dailyTrendChart"></canvas>
    </div>
  </div>

  <!-- Status Distribution -->
  <div class="glass-card spotlight-card magnetic-card rounded-2xl p-6 shadow-xl">
    <h3 class="text-lg font-bold text-gray-700 dark:text-gray-200 mb-6 flex items-center gap-2">
      <span class="p-2 bg-amber-100 dark:bg-amber-900/30 text-amber-600 rounded-lg">ğŸ“Š</span> Status Breakdown
    </h3>
    <div class="relative h-64 flex justify-center">
      <canvas id="statusChart"></canvas>
    </div>
  </div>

  <!-- Waste Type -->
  <div class="glass-card spotlight-card magnetic-card rounded-2xl p-6 shadow-xl">
    <h3 class="text-lg font-bold text-gray-700 dark:text-gray-200 mb-6 flex items-center gap-2">
      <span class="p-2 bg-eco-100 dark:bg-eco-900/30 text-eco-600 rounded-lg">ğŸ—‘ï¸</span> Waste Types
    </h3>
    <div class="relative h-64 flex justify-center">
      <canvas id="wasteTypeChart"></canvas>
    </div>
  </div>

  <!-- Severity -->
  <div class="glass-card spotlight-card magnetic-card rounded-2xl p-6 shadow-xl leading-relaxed">
    <h3 class="text-lg font-bold text-gray-700 dark:text-gray-200 mb-6 flex items-center gap-2">
      <span class="p-2 bg-red-100 dark:bg-red-900/30 text-red-600 rounded-lg">âš ï¸</span> Severity Analysis
    </h3>
    <div class="relative h-64 flex justify-center">
      <canvas id="severityChart"></canvas>
    </div>
  </div>

</div>

<script>
  // Parse Data from Django
  const statusData = JSON.parse('{{ status_counts|safe }}');
  const severityData = JSON.parse('{{ severity_counts|safe }}');
  const wasteTypeData = JSON.parse('{{ waste_type_counts|safe }}');
  const dailyData = JSON.parse('{{ daily_reports|safe }}');

  // Colors - Upgraded for High Vibrancy
  const colors = {
    green: '#22c55e', greenNeon: '#4ade80',
    yellow: '#facc15', yellowNeon: '#fde047',
    orange: '#f97316', orangeNeon: '#fb923c',
    blue: '#3b82f6', blueNeon: '#60a5fa',
    red: '#ef4444', redNeon: '#f87171',
    purple: '#a855f7', purpleNeon: '#c084fc'
  };

  // Helper: Create Linear Gradient for Charts
  function createChartGradient(ctx, color1, color2) {
    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, color1);
    gradient.addColorStop(1, color2);
    return gradient;
  }

  /* --- 1. Daily Trend Chart --- */
  const trendCtx = document.getElementById('dailyTrendChart').getContext('2d');
  new Chart(trendCtx, {
    type: 'line',
    data: {
      labels: dailyData.map(d => new Date(d.day).toLocaleDateString('en-US', { weekday: 'short' })),
      datasets: [{
        label: 'Reports',
        data: dailyData.map(d => d.count),
        borderColor: colors.blue,
        backgroundColor: createChartGradient(trendCtx, 'rgba(59, 130, 246, 0.5)', 'transparent'),
        fill: true,
        tension: 0.4,
        pointBackgroundColor: colors.blue,
        pointRadius: 6,
        pointHoverRadius: 8,
        borderWidth: 3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, grid: { color: 'rgba(255, 255, 255, 0.05)' } },
        x: { grid: { display: false } }
      }
    }
  });

  /* --- 2. Status Chart (Doughnut) --- */
  const statusLabels = statusData.map(d => d.status.charAt(0).toUpperCase() + d.status.slice(1).replace('_', ' '));
  const statusColorsMap = {
    'pending': colors.yellow,
    'assigned': colors.blue,
    'resolved': colors.green
  };
  const statusColors = statusData.map(d => statusColorsMap[d.status.toLowerCase()] || colors.purple);

  new Chart(document.getElementById('statusChart'), {
    type: 'doughnut',
    data: {
      labels: statusLabels,
      datasets: [{
        data: statusData.map(d => d.count),
        backgroundColor: statusColors,
        borderWidth: 0,
        hoverOffset: 25,
        borderRadius: 12,
        spacing: 8
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '82%',
      plugins: {
        legend: {
          position: 'bottom',
          labels: { color: '#9ca3af', font: { weight: 'bold', size: 11 }, padding: 15, usePointStyle: true, boxWidth: 8 }
        },
        tooltip: {
          backgroundColor: 'rgba(17, 24, 39, 0.9)',
          padding: 12,
          cornerRadius: 12,
          callbacks: {
            label: (ctx) => ` ${ctx.label}: ${ctx.raw} reports`
          }
        }
      },
      animation: { animateRotate: true, animateScale: true, duration: 2500, easing: 'easeOutElastic' }
    },
    plugins: [{
      id: 'statusCenterLabel',
      beforeDraw: (chart) => {
        const { ctx, width, height, chartArea: { top } } = chart;
        ctx.save();
        const total = statusData.reduce((acc, curr) => acc + curr.count, 0);
        ctx.font = 'bold 2rem Outfit, sans-serif';
        ctx.fillStyle = '#f3f4f6';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(total, width / 2, height / 2 + top - 10);
        ctx.font = 'bold 0.7rem Outfit, sans-serif';
        ctx.fillStyle = '#9ca3af';
        ctx.fillText('REPORTS', width / 2, height / 2 + top + 15);
        ctx.restore();
      }
    }]
  });

  /* --- 3. Waste Type Chart (Vibrant Polar Area) --- */
  new Chart(document.getElementById('wasteTypeChart'), {
    type: 'polarArea',
    data: {
      labels: wasteTypeData.map(d => d.waste_type),
      datasets: [{
        data: wasteTypeData.map(d => d.count),
        backgroundColor: [
          'rgba(16, 185, 129, 0.8)', // Emerald
          'rgba(245, 158, 11, 0.8)', // Amber
          'rgba(99, 102, 241, 0.8)', // Indigo
          'rgba(236, 72, 153, 0.8)', // Pink
          'rgba(139, 92, 246, 0.8)'  // Violet
        ],
        borderWidth: 3,
        borderColor: '#111827',
        hoverBorderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        r: {
          grid: { color: 'rgba(255, 255, 255, 0.05)' },
          angleLines: { color: 'rgba(255, 255, 255, 0.1)' },
          pointLabels: { display: true, color: '#9ca3af', font: { weight: 'bold', size: 10 } },
          ticks: { display: false }
        }
      },
      plugins: { legend: { display: false } }
    }
  });

  /* --- 4. Severity (Bar) --- */
  const sevCtx = document.getElementById('severityChart').getContext('2d');
  new Chart(sevCtx, {
    type: 'bar',
    data: {
      labels: severityData.map(d => d.severity.charAt(0).toUpperCase() + d.severity.slice(1)),
      datasets: [{
        label: 'Reports',
        data: severityData.map(d => d.count),
        backgroundColor: [
          createChartGradient(sevCtx, '#4ade80', '#16a34a'),
          createChartGradient(sevCtx, '#fde047', '#ca8a04'),
          createChartGradient(sevCtx, '#f87171', '#dc2626')
        ],
        borderRadius: 15,
        borderSkew: 5,
        hoverBackgroundColor: [colors.greenNeon, colors.yellowNeon, colors.redNeon]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      animation: {
        duration: 2500,
        easing: 'easeOutElastic'
      },
      scales: {
        y: { beginAtZero: true, grid: { color: 'rgba(255, 255, 255, 0.05)' } },
        x: { grid: { display: false } }
      }
    }
  });
</script>

{% endblock %}