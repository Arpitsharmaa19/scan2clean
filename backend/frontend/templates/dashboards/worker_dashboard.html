{% extends "dashboards/base_dashboard.html" %}

{% block dashboard_content %}

<!-- ü¶¥ Skeleton Loading Overlay -->
<div id="dashboard-skeleton"
  class="fixed inset-0 z-[60] bg-gray-50 dark:bg-gray-900 overflow-hidden pointer-events-none transition-opacity duration-700 p-8">
  <div class="max-w-7xl mx-auto space-y-8">
    <div class="h-48 w-full skeleton rounded-3xl"></div>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
      <div class="h-24 skeleton rounded-2xl"></div>
      <div class="h-24 skeleton rounded-2xl"></div>
      <div class="h-24 skeleton rounded-2xl"></div>
      <div class="h-24 skeleton rounded-2xl"></div>
    </div>
    <div class="h-96 w-full skeleton rounded-3xl"></div>
  </div>
</div>

<script>
  window.addEventListener('load', () => {
    const skeleton = document.getElementById('dashboard-skeleton');
    if (skeleton) {
      skeleton.style.opacity = '0';
      setTimeout(() => skeleton.remove(), 700);
    }
  });
</script>

<!-- üåà Header -->
<div
  class="relative min-h-[160px] md:min-h-[180px] rounded-[1.5rem] md:rounded-[2.5rem] p-6 md:p-10 text-white mb-6 md:mb-8 overflow-hidden shadow-2xl animate-fade-up group">
  <!-- Dynamic Gradient Background -->
  <div
    class="absolute inset-0 bg-gradient-to-br from-gray-900 via-emerald-950 to-indigo-950 transition-transform duration-1000 group-hover:scale-105">
  </div>

  <!-- Content Decor -->
  <div class="absolute top-0 right-0 p-8 opacity-10 text-8xl">üöõ</div>
  <div class="absolute bottom-0 right-1/4 p-4 opacity-5 text-6xl">üõ†Ô∏è</div>
  <div class="scan-beam"></div>
  <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-20"></div>
  <div class="scan-beam"></div>
  <div
    class="absolute -right-10 -bottom-10 text-9xl opacity-20 transform rotate-12 group-hover:rotate-6 transition-transform duration-700">
    üöõ</div>

  <div class="relative z-10 flex flex-col md:flex-row items-center gap-4 md:gap-8">
    <div
      class="h-14 w-14 md:h-20 md:w-20 bg-white/10 backdrop-blur-md rounded-2xl md:rounded-3xl flex items-center justify-center text-2xl md:text-4xl border border-white/20 shadow-2xl animate-float">
      üöõ
    </div>

    <div class="flex-1 text-center md:text-left">
      <h1 class="text-xl md:text-4xl font-heading font-bold mb-1 text-white drop-shadow-sm leading-tight">
        Welcome back, {{ request.user.first_name|default:request.user.username }}!
      </h1>
      <p class="text-blue-50 text-[10px] md:text-lg font-medium opacity-90 uppercase tracking-widest">
        <strong>{{ pending_tasks|default:"0" }}</strong> active jobs
      </p>
    </div>

    <!-- üì° Live Uplink Toggle -->
    <div
      class="glass p-1 rounded-2xl flex items-center gap-1 shadow-2xl border-white/20 w-full md:w-auto justify-center">
      <label class="relative inline-flex items-center cursor-pointer group p-2">
        <input type="checkbox" id="worker-online-toggle" class="sr-only peer">
        <div
          class="relative w-10 h-5 bg-gray-700/50 peer-focus:outline-none rounded-full peer peer-checked:bg-green-500/80 transition-all duration-300 after:content-[''] after:absolute after:top-[3px] after:left-[3px] after:bg-white after:rounded-full after:h-3.5 after:w-3.5 after:transition-all after:duration-300 peer-checked:after:translate-x-5 shadow-inner">
        </div>
        <span class="ms-3 text-[9px] font-black text-white uppercase tracking-[0.2em]" id="status-text">Offline</span>
      </label>
      <div id="status-beacon" class="hidden pr-3">
        <div class="relative flex h-2 w-2">
          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
          <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- üìä Worker Stats -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">

  <!-- üìä Chart Card -->
  <div
    class="glass-card spotlight-card magnetic-card rounded-2xl p-5 shadow-lg animate-fade-up flex flex-col h-[200px]">
    <h3 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-3 text-center">Efficiency Rate</h3>
    <div class="relative h-full w-full flex items-center justify-center">
      <canvas id="workerChart"></canvas>
      <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
        <span id="worker-goal-text" class="text-xl font-black text-gray-800 dark:text-white leading-none">0/0</span>
        <span class="text-[7px] font-bold text-gray-400 uppercase tracking-tighter">Done</span>
      </div>
      {% if assigned_tasks == 0 and completed_tasks == 0 and pending_tasks == 0 %}
      <div
        class="absolute inset-0 flex items-center justify-center bg-gray-50/80 dark:bg-gray-800/80 backdrop-blur-sm rounded-xl">
        <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">No Active Tasks</p>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- ‚è≥ Pending -->
  <div
    class="glass-card spotlight-card magnetic-card rounded-2xl p-5 shadow-lg border-l-4 border-teal-400 h-[200px] flex flex-col justify-center">
    <div class="flex justify-between items-start">
      <div>
        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">On Route</p>
        <p class="text-3xl font-black text-gray-800 dark:text-white">{{ pending_tasks|default:"0" }}</p>
      </div>
      <div class="h-10 w-10 bg-teal-100 dark:bg-teal-900/30 rounded-xl flex items-center justify-center text-xl">‚è≥
      </div>
    </div>
  </div>

  <!-- ‚úÖ Completed -->
  <div
    class="glass-card spotlight-card magnetic-card rounded-2xl p-5 shadow-lg border-l-4 border-green-500 h-[200px] flex flex-col justify-center">
    <div class="flex justify-between items-start">
      <div>
        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">Cleaned</p>
        <p class="text-3xl font-black text-gray-800 dark:text-white">{{ completed_tasks|default:"0" }}</p>
      </div>
      <div class="h-10 w-10 bg-green-100 dark:bg-green-900/30 rounded-xl flex items-center justify-center text-xl">‚úÖ
      </div>
    </div>
  </div>

  <!-- ‚≠ê Rating Card -->
  <div
    class="glass-card spotlight-card magnetic-card rounded-2xl p-5 shadow-lg border-l-4 border-emerald-500 h-[200px] flex flex-col justify-center">
    <div class="flex justify-between items-start">
      <div>
        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">Impact Score</p>
        <div class="flex items-center gap-2">
          <p class="text-3xl font-black text-gray-800 dark:text-white">{{ request.user.average_rating|floatformat:1 }}
          </p>
          <span class="text-xl text-yellow-400">‚òÖ</span>
        </div>
        <p class="text-[9px] text-gray-500 font-bold uppercase mt-1">{{ request.user.total_ratings }} reviews</p>
      </div>
      <div class="h-10 w-10 bg-emerald-100 dark:bg-emerald-900/30 rounded-xl flex items-center justify-center text-xl">‚≠ê
      </div>
    </div>
  </div>

</div>

<!-- üóÇÔ∏è Priority Jobs -->
<div class="glass-card spotlight-card magnetic-card rounded-3xl p-8 shadow-xl animate-fade-up relative overflow-hidden">
  <div class="scan-beam" style="animation-duration: 5s; opacity: 0.2;"></div>
  <div class="flex flex-col sm:flex-row items-center justify-between gap-4 mb-8">
    <h3 class="text-lg md:text-xl font-heading font-bold text-gray-800 dark:text-gray-100 flex items-center gap-3">
      <span class="p-2 bg-red-100 dark:bg-red-900/30 rounded-xl text-lg">üö®</span> Priority Jobs
    </h3>
    <div class="flex items-center gap-3 w-full sm:w-auto">
      <button onclick="calculateOptimizedRoute()"
        class="flex-1 sm:flex-none bg-gradient-to-r from-eco-600 to-teal-600 text-white px-3 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg hover:shadow-eco-500/40 transition-all flex items-center justify-center gap-2">
        <span>üöÄ</span> Route
      </button>
      <a href="{% url 'worker_assigned_reports' %}"
        class="text-[10px] font-black text-blue-600 hover:text-blue-700 uppercase tracking-widest whitespace-nowrap">Queue
        ‚Üí</a>
    </div>
  </div>

  {% if assigned_reports %}
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    {% for report in assigned_reports %}
    <div
      class="flex gap-5 p-5 rounded-2xl bg-gray-50/50 dark:bg-gray-800/50 border border-gray-100 dark:border-gray-700/50 hover:bg-white dark:hover:bg-gray-800 transition-all duration-300 shadow-sm group magnetic-card relative overflow-hidden">
      <div class="scan-beam" style="animation-duration: 8s; opacity: 0.1;"></div>
      <div
        class="h-24 w-24 rounded-2xl overflow-hidden shadow-md flex-shrink-0 group-hover:scale-105 transition-transform">
        {% if report.image %}
        <img src="{{ report.image.url }}" class="h-full w-full object-cover">
        {% else %}
        <div class="h-full w-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-2xl">üì∏</div>
        {% endif %}
      </div>

      <div class="flex-grow min-w-0 flex flex-col justify-between">
        <div>
          <div class="flex justify-between items-start mb-1">
            <h4 class="font-bold text-gray-800 dark:text-white truncate text-sm">Job #{{ report.id }}</h4>
            <span class="px-2 py-0.5 rounded-md text-[8px] font-black uppercase bg-red-100 text-red-600">{{ report.severity }}</span>
          </div>
          <p class="text-[10px] text-gray-500 dark:text-gray-300 mb-3 line-clamp-1 italic">"{{ report.description }}"
          </p>
        </div>

        <div class="mt-auto flex items-center gap-3">
          {% if report.verification_otp %}
          <form method="post" action="{% url 'verify_otp' report.id %}" class="flex gap-2 w-full">
            {% csrf_token %}
            <input type="text" name="otp" placeholder="CODE" required
              class="w-16 px-2 py-2 rounded-xl text-xs border-2 border-blue-200 dark:border-blue-700 bg-white dark:bg-gray-800 text-center font-black tracking-widest outline-none focus:border-blue-500">
            <button type="submit"
              class="flex-1 bg-blue-600 text-white px-3 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-blue-700 shadow-lg shadow-blue-500/20 active:scale-95 transition-all">Verify</button>
          </form>
          {% else %}
          <form method="post" action="{% url 'resolve_report' report.id %}" class="w-full">
            {% csrf_token %}
            <button
              class="w-full py-2.5 bg-eco-600 hover:bg-eco-700 text-white rounded-xl font-black text-[10px] uppercase tracking-widest shadow-lg shadow-eco-500/20 active:scale-95 transition-all">‚úÖ
              Resolve</button>
          </form>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="text-center py-12">
    <div class="text-6xl mb-4 grayscale opacity-30">‚úÖ</div>
    <p class="text-gray-500 dark:text-gray-400 font-medium">All clear! No pending tasks in your area.</p>
  </div>
  {% endif %}
</div>

<!-- Leaflet & Routing -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<!-- üó∫Ô∏è Active Mission Map (Appears after Beginning) -->
<div id="active-mission-container" class="hidden mb-12 animate-fade-up">
  <div
    class="glass-card spotlight-card magnetic-card rounded-3xl p-8 shadow-xl border border-blue-100 dark:border-blue-900/40 relative overflow-hidden">
    <div class="flex items-center justify-between mb-6">
      <h3 class="text-xl font-heading font-bold text-gray-800 dark:text-gray-100 flex items-center gap-3">
        <span class="p-2 bg-blue-100 dark:bg-blue-900/30 rounded-xl text-lg">üéØ</span> Active Mission Path
      </h3>
      <button onclick="stopMission()"
        class="text-[10px] font-black uppercase text-red-500 hover:text-red-600 tracking-widest">End Mission</button>
    </div>
    <div class="h-[400px] rounded-24 overflow-hidden border border-gray-100 dark:border-gray-700 shadow-inner relative">
      <div id="main-mission-map" class="h-full w-full z-10"></div>
    </div>
  </div>
</div>

<div id="routing-modal" class="fixed inset-0 z-[100] hidden">
  <div class="absolute inset-0 bg-gray-900/60 backdrop-blur-sm" onclick="closeRoutingModal()">
  </div>
  <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-4xl">
    <div class="glass-card spotlight-card rounded-3xl p-8 shadow-2xl animate-scale-in border border-white/20 m-4">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold font-heading text-gray-800 dark:text-white flex items-center gap-2">
          <span>üöÄ</span> Optimized Mission Path
        </h3>
        <button onclick="closeRoutingModal()" class="text-gray-400 hover:text-gray-600 p-2">‚úï</button>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- List View -->
        <div id="routing-content" class="space-y-4 max-h-[450px] overflow-y-auto pr-2 custom-scrollbar">
          <!-- Content injected by JS -->
        </div>

        <!-- Map View -->
        <div
          class="relative h-[450px] rounded-2xl overflow-hidden border border-gray-100 dark:border-gray-700 shadow-inner bg-gray-50 dark:bg-gray-800">
          <div id="routing-map" class="h-full w-full z-10"></div>
        </div>
      </div>

      <div
        class="mt-8 pt-6 border-t border-gray-100 dark:border-gray-700 flex flex-col sm:flex-row items-center justify-between gap-4">
        <p class="text-[10px] text-gray-500 font-bold uppercase tracking-widest text-center sm:text-left">Road-aware
          batching applied</p>
        <button onclick="beginMission()"
          class="w-full sm:w-auto px-12 py-4 bg-blue-600 dark:bg-white dark:text-gray-900 text-white font-black text-xs uppercase tracking-[0.2em] rounded-2xl hover:scale-[1.02] active:scale-95 transition-all shadow-xl shadow-blue-500/20">
          Confirm & Begin Mission
        </button>
      </div>
    </div>
  </div>
  <style>
    .leaflet-routing-container {
      display: none !important;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    let routingMap = null;
    let activeMissionMap = null;
    let routingMarkers = [];
    let routingControl = null;
    let missionRoutingControl = null;
    let workerMarkerMain = null;
    let missionWaypoints = [];

    function closeRoutingModal() {
      document.getElementById('routing-modal').classList.add('hidden');
    }

    function beginMission() {
      closeRoutingModal();
      document.getElementById('active-mission-container').classList.remove('hidden');

      if (!activeMissionMap) {
        activeMissionMap = L.map('main-mission-map').setView([0, 0], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(activeMissionMap);
      }

      // Clear old mission route
      if (missionRoutingControl) activeMissionMap.removeControl(missionRoutingControl);

      // Setup New Mission Plan
      missionRoutingControl = L.Routing.control({
        waypoints: missionWaypoints,
        routeWhileDragging: false,
        addWaypoints: false,
        draggableWaypoints: false,
        fitSelectedRoutes: true,
        show: false,
        lineOptions: {
          styles: [{ color: '#22c55e', opacity: 0.8, weight: 6 }]
        },
        createMarker: function (i, wp) {
          if (i === 0) return null; // Don't show marker at start, we use the truck icon
          return L.marker(wp.latLng, {
            icon: L.divIcon({
              html: `<div class="bg-green-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold border-2 border-white shadow-lg">${i}</div>`,
              iconSize: [32, 32],
              iconAnchor: [16, 16]
            })
          });
        }
      }).addTo(activeMissionMap);

      showToast("Mission Accepted", "Real-road routing active. Your movement is now live.", "success");
      setTimeout(() => activeMissionMap.invalidateSize(), 500);

      // Initial Marker Sync
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((pos) => {
          updateMainMarker(pos.coords.latitude, pos.coords.longitude);
        });
      }
    }

    function stopMission() {
      document.getElementById('active-mission-container').classList.add('hidden');
      if (missionRoutingControl) activeMissionMap.removeControl(missionRoutingControl);
      showToast("Mission Ended", "Navigation stopped.", "info");
    }

    async function calculateOptimizedRoute() {
      try {
        showToast("Calculating...", "Analysing road networks...", "info");
        const response = await fetch('/api/waste-reports/optimized_route/');
        const data = await response.json();

        if (!response.ok || data.error) {
          // Handle specific error types with better messages
          if (data.error === 'no_location_data') {
            showToast("‚ùå Location Missing", data.message || "Reports are missing location data", "error");
          } else if (data.message) {
            showToast("Routing Error", data.message, "error");
          } else {
            showToast("Routing Error", data.error || "Unable to calculate route", "error");
          }
          return;
        }

        const content = document.getElementById('routing-content');
        const modal = document.getElementById('routing-modal');

        modal.classList.remove('hidden');

        if (!routingMap) {
          routingMap = L.map('routing-map').setView([0, 0], 13);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
          }).addTo(routingMap);
        }

        if (routingControl) routingMap.removeControl(routingControl);

        if (!data.batches || data.batches.length === 0) {
          content.innerHTML = '<div class="text-center py-10 text-gray-400">No active jobs to optimize.</div>';
        } else {
          // List View Rendering
          content.innerHTML = data.batches.map((batch, index) => `
          <div class="relative pl-8 pb-4">
            <div class="absolute left-0 top-0 bottom-0 w-px bg-blue-100 dark:bg-blue-900/30"></div>
            <div class="absolute left-[-4px] top-0 h-2 w-2 rounded-full bg-blue-600 border-4 border-blue-100 dark:border-blue-900/50"></div>
            <div class="bg-blue-50/50 dark:bg-blue-900/10 p-4 rounded-2xl border border-blue-100/50 dark:border-blue-900/20">
              <div class="flex justify-between items-start mb-2">
                <span class="text-[9px] font-black text-blue-600 uppercase tracking-widest text-blue-600">Stop #${index + 1}</span>
              </div>
              <h4 class="font-bold text-gray-800 dark:text-white text-sm">Report #${batch.main_report.id}</h4>
              <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">${batch.main_report.type} - ${batch.main_report.severity} Priority</p>
            </div>
          </div>
        `).join('');

          // Prepare Waypoints
          missionWaypoints = [];
          if (data.worker_location) {
            missionWaypoints.push(L.latLng(data.worker_location.lat, data.worker_location.lng));
          }
          data.batches.forEach(batch => {
            missionWaypoints.push(L.latLng(batch.main_report.lat, batch.main_report.lng));
          });

          // Add Road-Aware Polyline
          routingControl = L.Routing.control({
            waypoints: missionWaypoints,
            routeWhileDragging: false,
            addWaypoints: false,
            draggableWaypoints: false,
            fitSelectedRoutes: true,
            show: false,
            lineOptions: {
              styles: [{ color: '#3b82f6', opacity: 0.6, weight: 4 }]
            },
            createMarker: function (i, wp) {
              if (i === 0) return null; // Use manual marker or truck
              return L.marker(wp.latLng, {
                icon: L.divIcon({
                  html: `<div class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-[10px] font-bold border-2 border-white shadow-lg">${i}</div>`,
                  iconSize: [24, 24],
                  iconAnchor: [12, 12]
                })
              });
            }
          }).addTo(routingMap);

          setTimeout(() => routingMap.invalidateSize(), 300);
        }
      } catch (err) {
        console.error(err);
        showToast("Error", "Routing engine unavailable.", "error");
      }
    }

    // Handle Live Updates for Marker Position
    function updateMainMarker(lat, lng) {
      if (!activeMissionMap) return;

      if (!workerMarkerMain) {
        workerMarkerMain = L.marker([lat, lng], {
          icon: L.divIcon({
            html: `<div class="relative"><div class="absolute -inset-4 bg-blue-500/20 rounded-full animate-ping"></div><div class="relative bg-blue-600 text-white p-3 rounded-full border-2 border-white shadow-2xl flex items-center justify-center text-xl">üöõ</div></div>`,
            iconSize: [40, 40],
            iconAnchor: [20, 20]
          })
        }).addTo(activeMissionMap);
      } else {
        workerMarkerMain.setLatLng([lat, lng]);
      }

      // Dynamic Waypoint Update (Start from current pos)
      if (missionRoutingControl) {
        const wps = missionRoutingControl.getWaypoints();
        wps[0] = L.Routing.waypoint(L.latLng(lat, lng));
        missionRoutingControl.setWaypoints(wps);
      }
    }

    // üõ∞Ô∏è Worker Live Broadcasting Logic
    document.addEventListener('DOMContentLoaded', () => {
      const toggle = document.getElementById('worker-online-toggle');
      const statusText = document.getElementById('status-text');
      const beacon = document.getElementById('status-beacon');
      let locationInterval = null;
      let socket = null;

      function connectSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
        socket = new WebSocket(`${protocol}${window.location.host}/ws/location/worker/`);

        socket.onopen = () => console.log("üì° System Uplink Established");
        socket.onclose = () => {
          console.warn("üì° Uplink Lost. Retrying...");
          if (toggle.checked) setTimeout(connectSocket, 5000);
        };
      }

      function sendLocation() {
        if (!navigator.geolocation) return;

        navigator.geolocation.getCurrentPosition((position) => {
          if (socket && socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({
              lat: position.coords.latitude,
              lng: position.coords.longitude
            }));
            console.log("üìç Location Sync:", position.coords.latitude, position.coords.longitude);

            // Update local mission map
            if (typeof updateMainMarker === 'function') {
              updateMainMarker(position.coords.latitude, position.coords.longitude);
            }
          }
        }, (err) => console.error("üìç GPS Error:", err), {
          enableHighAccuracy: true
        });
      }

      toggle.addEventListener('change', () => {
        if (toggle.checked) {
          statusText.innerText = "Online";
          statusText.classList.replace('text-white', 'text-green-400');
          beacon.classList.remove('hidden');

          connectSocket();
          sendLocation(); // Initial send
          locationInterval = setInterval(sendLocation, 10000); // Sync every 10s

          showToast("System Online", "Your live location is now visible to citizens tracking their reports.", "success");
        } else {
          statusText.innerText = "Offline";
          statusText.classList.replace('text-green-400', 'text-white');
          beacon.classList.add('hidden');

          if (locationInterval) clearInterval(locationInterval);
          if (socket) socket.close();

          showToast("System Offline", "Location broadcasting has been disabled.", "info");
        }
      });

      // Handle initial state if needed
      if (toggle.checked) {
        connectSocket();
        locationInterval = setInterval(sendLocation, 10000);
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      const assignedVal = Number("{{ assigned_tasks|default:'0' }}");
      const completedVal = Number("{{ completed_tasks|default:'0' }}");
      const pendingVal = Number("{{ pending_tasks|default:'0' }}");

      const canvas = document.getElementById('workerChart');
      if (canvas) {
        const ctx = canvas.getContext('2d');
        const total = completedVal + pendingVal;

        // Update Goal Text
        const goalText = document.getElementById('worker-goal-text');
        if (goalText) {
          goalText.innerText = `${completedVal}/${total}`;
        }

        new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['Done', 'On Route'],
            datasets: [{
              data: [completedVal, pendingVal],
              backgroundColor: ['#22c55e', '#3b82f6'],
              hoverBackgroundColor: ['#4ade80', '#60a5fa'],
              borderWidth: 0,
              hoverOffset: 12,
              borderRadius: 4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '78%',
            layout: {
              padding: 10
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                enabled: true,
                callbacks: {
                  label: function (context) {
                    return ` ${context.label}: ${context.raw} units`;
                  }
                }
              }
            },
            animation: {
              animateRotate: true,
              animateScale: true,
              duration: 2500,
              easing: 'easeOutElastic'
            }
          }
        });
      }
    });
  </script>

  {% endblock %}